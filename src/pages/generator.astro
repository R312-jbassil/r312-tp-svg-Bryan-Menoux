---
// ========================================
// Configuration et imports

import Layout from "../layouts/Layout.astro";
import { ui } from "../i18n/ui.js";

const locale = (Astro.locals.lang as "en" | "fr") ?? "en";
const user = Astro.locals.user;
console.log("Locale in generator:", locale);
---

<Layout>
  <div class="flex h-full flex-col overflow-hidden bg-base-200">
    <!-- Zone principale -->
    <div class="flex flex-1 gap-4 overflow-hidden p-4">
      <!-- Rendu SVG -->
      <div class="flex w-1/2 flex-col gap-2">
        <h2 class="text-lg font-semibold text-primary">
          {ui[locale].generator.title || "Rendu SVG"}
        </h2>
        <div
          id="svg-container"
          class="flex flex-1 items-center justify-center overflow-auto rounded-2xl border-2 border-primary/30 bg-base-100 p-6"
        >
          <span class="text-base-content/60"
            >{ui[locale].generator.waiting}</span
          >
        </div>
      </div>

      <!-- Code SVG -->
      <div class="flex w-1/2 flex-col gap-2">
        <h2 class="text-lg font-semibold text-secondary">Code SVG</h2>
        <div
          class="mockup-window flex-1 overflow-hidden border border-secondary/20 bg-base-300"
        >
          <pre
            id="svg-output"
            class="h-full w-full overflow-auto whitespace-pre-wrap break-words bg-zinc-900 p-4 text-sm text-zinc-100">
          </pre>
        </div>
      </div>
    </div>

    <!-- Barre d'interaction -->
    <div class="border-t-2 border-primary/30 bg-base-100 p-4">
      <div class="flex w-full items-center gap-3">
        <input
          id="user-prompt"
          type="text"
          placeholder={ui[locale].generator.placeholder}
          class="input input-bordered flex-1"
        />
        <button id="generate-button" class="btn btn-primary">
          {ui[locale].generator.generateButton}
        </button>
        <button id="edit-button" class="btn btn-secondary">
          {ui[locale].generator.editButton}
        </button>
        <button id="save-button" class="btn btn-accent gap-2">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            fill="currentColor"
            viewBox="0 0 30 30"
          >
            <path
              d="M23,27l-8-7l-8,7V5c0-1.105,0.895-2,2-2h12c1.105,0,2,0.895,2,2V27z"
            ></path>
          </svg>
          Sauvegarder
        </button>
      </div>
    </div>
  </div>
</Layout>

<script>
  //@ts-nocheck
  // ========================================
  // Imports et configuration

  import { createNewFavorite } from "../lib/pocketbase";

  const locale = document.documentElement.getAttribute("data-locale") || "fr";

  // ========================================
  // Traductions

  const translations = {
    fr: {
      promptName: "Donnez un nom à votre création :",
      nameEmptyError: "Le nom ne peut pas être vide.",
      saveSuccess: "SVG sauvegardé avec succès !",
      saveError: "Erreur lors de la sauvegarde : ",
    },
    en: {
      promptName: "Give a name to your creation:",
      nameEmptyError: "The name cannot be empty.",
      saveSuccess: "SVG saved successfully!",
      saveError: "Error while saving: ",
    },
  };

  const t = translations[locale] || translations.fr;

  // ========================================
  // Fonction génération SVG

  async function generateSVG(prompt) {
    console.log(prompt);

    const res = await fetch("/apis/generateSVG", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(prompt),
    });
    return (await res.json()).svg;
  }
  let promptList = [];

  // ========================================
  // Bouton modifier

  const editButton = document.getElementById("edit-button");

  async function handleEdit() {
    let prompt = "";
    let aiResponse = "";
    const promptElement = document.getElementById("user-prompt");
    prompt = promptElement ? promptElement.value : "";
    console.log("Prompt soumis : ", prompt);
    // Ajout du prompt de l'utilisateur à la liste
    promptList.push({ role: "user", content: prompt });
    const svgContainer = document.getElementById("svg-container");
    // Afficher un spinner de chargement
    svgContainer.innerHTML += `<span class="loading loading-ring loading-xl"></span>`;
    generateButton.disabled = true;
    editButton.disabled = true;
    let svgOutput = document.getElementById("svg-output");
    // Appeler la fonction pour générer le SVG
    aiResponse = await generateSVG(promptList);
    // Extraire le SVG de la réponse
    const svgMatch = aiResponse.content.match(/<svg[\s\S]*?<\/svg>/i);
    aiResponse.content = svgMatch ? svgMatch[0] : "";
    console.log("Code SVG généré : ", aiResponse.content);
    // Ajouter la réponse de l'IA à la liste des prompts
    promptList.push(aiResponse);
    // Afficher le SVG généré
    svgOutput.textContent = aiResponse.content;
    svgContainer.innerHTML = aiResponse.content;
    // Réactiver les boutons
    generateButton.disabled = false;
    editButton.disabled = false;
    console.log("Historique des prompts : ", promptList);
  }

  if (editButton) {
    editButton.addEventListener("click", handleEdit);
  }

  // ========================================
  // Bouton générer

  async function handleSubmit() {
    let prompt = "";
    let aiResponse = "";
    const promptElement = document.getElementById("user-prompt");
    prompt = promptElement ? promptElement.value : "";
    console.log("submitted: ", prompt);
    // Réinitialiser la liste des prompts
    promptList.length = 0;
    promptList.push({ role: "user", content: prompt });
    const svgContainer = document.getElementById("svg-container");
    // Afficher un spinner
    svgContainer.innerHTML = `<span class="loading loading-ring loading-xl"></span>`;
    generateButton.disabled = true;
    editButton.disabled = true;
    let svgOutput = document.getElementById("svg-output");
    // Appeler la fonction pour générer le SVG
    aiResponse = await generateSVG(promptList);
    // Extraire le SVG de la réponse
    const svgMatch = aiResponse.content.match(/<svg[\s\S]*?<\/svg>/i);
    aiResponse.content = svgMatch ? svgMatch[0] : "";
    console.log("svgCode: ", aiResponse.content);
    // Ajouter la réponse de l'IA à la liste des prompts
    promptList.push(aiResponse);
    // Afficher le SVG généré
    svgOutput.textContent = aiResponse.content;
    svgContainer.innerHTML = aiResponse.content;
    // Réactiver les boutons
    generateButton.disabled = false;
    editButton.disabled = false;
  }

  // ========================================
  // Écouteurs d'événements génération

  const generateButton = document.getElementById("generate-button");
  const input = document.getElementById("user-prompt");
  generateButton.addEventListener("click", handleSubmit);
  input.addEventListener("keypress", (e) => {
    if (e.key === "Enter") handleSubmit();
  });

  // ========================================
  // Récupération utilisateur

  const actionZone = document.getElementById("normal-zone");
  const svgOutput = document.getElementById("svg-output");

  const successDiv = document.createElement("div");
  document.body.appendChild(successDiv);
  const user = JSON.parse(localStorage.getItem("user") ?? "null");

  // ========================================
  // Fonction sauvegarde SVG

  const saveButton = document.getElementById("save-button");

  async function saveSVG(params) {
    // Envoi de la requête à notre endpoint
    const res = await fetch("/apis/saveSVG", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(params),
    });
    return await res.json();
  }

  // ========================================
  // Gestionnaire bouton sauvegarde

  if (saveButton) {
    saveButton.addEventListener("click", async () => {
      console.log("Tentative de sauvegarde du SVG...");
      if (!user || !user.id) {
        alert("Vous devez être connecté pour sauvegarder un SVG.");
        return;
      }
      // Demande du nom du SVG à l'utilisateur
      const name = prompt(t.promptName);
      if (name === null || name.trim() === "") {
        alert(t.nameEmptyError);
        return;
      }
      const svgOutput = document.getElementById("svg-output")?.textContent;
      console.log("Préparation de la sauvegarde :", JSON.stringify(svgOutput));

      // Préparation des données pour la sauvegarde
      const params = {
        nom: name,
        code_svg: svgOutput || "<svg></svg>", // SVG par défaut si vide
        chat_history: JSON.stringify(promptList), // Historique des échanges
        user: user.id,
      };

      // Sauvegarde et gestion de la réponse
      const result = await saveSVG(params);
      if (result.success) {
        alert(t.saveSuccess);
      } else {
        alert(t.saveError + result.error);
      }
    });
  }
</script>
